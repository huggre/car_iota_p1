# Integrating physical devices with IOTA — Car-IOTA Part 1

## The 12th part in a series of beginner tutorials on integrating physical devices with the IOTA protocol.

![img](https://miro.medium.com/max/3264/1*V3nqON9axYIEz_87lxCzjw.jpeg)

------

# Introduction

This is the 12th part in a series of beginner tutorials where we explore integrating physical devices with the IOTA protocol. This time we will look at simplifying and automating payments for typical car related services such as parking, toll-road, washing etc. using the IOTA protocol.

I decided to make this a two part tutorial as i believe there are multiple ways of approaching this use-case. Each with its own advantages and disadvantages. More about that later.

In this first tutorial we will try to solve the use-case by utilizing a technology commonly referred to as Automatic License Plate Recognition, or ALPR for short.

------

# The Use Case

In the back of our hotel there is a parking facility available for hotel guests and staff. Lately there have been problems with both authorized and unauthorized people using the parking facility without paying the required parking fees. Our hotel owner believes that this is related to the current manual and complicated process for handling parking fees. If only there was an automated system that could take care of collecting parking fees without bothering his guests or staff. After all, the current situation is loosing him money together with making his guests and staff frustrated. Something must be done.

*Note!*
*The solution proposed in this tutorial is based on the idea that the hotel owner issues IOTA tokens and manages the SEEDS for his guests and staff. This idea was discussed in previous tutorial where we looked at using RFID technology when paying for various services at the hotel. I suggest you quickly browse through these tutorials as an introduction to how is might work.*

[*The IOTA Debit card, Part 1*](https://medium.com/coinmonks/integrating-physical-devices-with-iota-the-iota-debit-card-part-1-42dc1a05f18)[*The IOTA Debit card, Part 2*](https://medium.com/coinmonks/integrating-physical-devices-with-iota-the-iota-debit-card-part-2-1f073060ae1d)[*The IOTA Debit card, Part 3*](https://medium.com/coinmonks/integrating-physical-devices-with-iota-the-iota-debit-card-part-3-bc0f03b8b2c9)

------

# The components

Before we start looking at the coding for this project, we should take a step back and look at the overall concept and the various components used.

![img](https://miro.medium.com/max/30/1*PQAay-gV2ZTj6KVzcwoSAQ.png?q=20)

![img](https://miro.medium.com/max/777/1*PQAay-gV2ZTj6KVzcwoSAQ.png)

Above you will see a simple layout of the various components being utilized to solve the use-case as proposed in this tutorial. Let’s brake them down one by one before moving on to the code.

**Ultrasonic Sensor**
The ultrasonic sensor is used to detect when a vehicle is entering or exiting the parking lot. An ultrasonic sensor measure distance by generating and receiving sound pulses. So its basically just a speaker and microphone with some additional electronics combined into one unit. By measuring the time from when a pulse was sent by the speaker, to the time the pulse was received by the microphone, we calculate the distance (as we know the speed of sound) to the object (in this case the vehicle) that reflected the pulse.

The ultrasonic sensor i used for this project is the popular HC-SR04. You should be able to get one of these off ebay for a couple of bucks.

![img](https://miro.medium.com/max/360/0*avz8L4pphuwHXa-w.jpg)

Use the following circuit diagram to hook up the HC-SR04 to your Raspberry PI.

![img](https://miro.medium.com/max/640/1*1anKi8tfDdVsdTQhFa9LVQ.png)

*Warning!*
*Notice the two resistors placed in the circuit. The resistors are used to lower the voltage from the 5V output pin of the HC-SR04 to the 3.5 V input pin on the PI. Not having the voltage resistors in the circuit could damage your Raspberry PI.*

*Note!*
*There are of course various technologies you could use to detect when a vehicle enters or exits the parking lot. The only reason i’m using an ultrasonic sensor for this project was that i already had one laying around from a previous project.*

*Note!*
*Notice that the sound pulses generated by the sensor is in a frequency range not detectable by the human ear, so you will not hear any sound when the sensor is active.*

**Camera**
The camera is used to take a picture of the vehicle license plate as it enters the parking lot area. I’m using the Raspberry PI camera module V2 for this project, but you could basically use any camera that can be controlled from a Python script. You should be able to get this camera module off ebay or from your local PI shop. On ebay you can also get fully functional Chinese knock-offs for only a few bucks.

![img](https://miro.medium.com/max/425/1*1yFD7yoGj1XdxBbIq0qDdw.jpeg)

**OpenALPR**
OpenALPR is an Automatic License Plate Recognition (ALPR) software used to identify license plate numbers from a picture or image. You have the option of installing the OpenALPR SDK on-premise, or use there cloud service to perform the ALPR. For this tutorial we will be using the cloud service. Notice that OpenALPR is licensed software, but you may sign up for a free account that allows you to perform up to 1000 ALPR’s a month for free.

To sign up for a free OpenALPR account, go to https://www.openalpr.com/

After login in to OpenALPR, select Cloud API

On the Cloud API page you will find a secret key that will be used in our python script when uploading images to the OpenALPR cloud service.

![img](https://miro.medium.com/max/781/1*hZ324THau3bFIeJdG6EYkg.png)

**The Plate/SEED DB**
The “Plate/SEED DB” is a reference to some type of centralized storage where each license plate number is pared with the IOTA SEED that will be used as sender of the IOTA value transaction. In this tutorial i’m using a simple comma separated text file (or CSV) file stored locally on the Raspberry PI. However, in any real life scenario where security is a priority, the SEED’s should probably be stored in some type of encrypted database with restricted access.

**The Car**
We also need some object representing the car itself. As you can see from the images in this tutorial, i’m using a toy car that i found at a flea market near by. For building and testing you only need a simple simple box with a printed license plate on one side as shown below. Or even cooler, setting up the system in its intended environment, using real cars and license plates.

![img](https://miro.medium.com/max/3264/1*L2XJTI8dwMD71-EVXfXlcA.jpeg)

*Note!*
*Make sure you draw a border around the license plate number as shown above. Otherwise the OpenALPR algorithms will have problems identifying where the license plate located within the picture.*

------

# How it works

Before looking at the Python code for this project, lets take a step-by-step look at the events as they unfold when a new car enters the hotel parking lot.

1. A new car enters the hotel parking lot and blocks the ultrasonic sensor.
2. A picture of the license plate area of the car is taken by the camera.
3. The picture is uploaded to the OpenALPR Cloud service that returns the identified license plate number in the form of a json object.
4. We convert the license plate number from the json object to a string before searching the Plate/SEED DB for a match.
5. If a match was found, we return the related IOTA SEED before issuing a value transaction to the tangle, using the returned SEED as sender for the transaction.

For reference:
Here is a picture taken from the PI camera as the car enters the parking lot and blocks the ultrasonic sensor.

![img](https://miro.medium.com/max/2592/1*a71f0S876Ec1BevRtwcYzA.jpeg)

and here is the picture as decoded by OpenALPR

![img](https://miro.medium.com/max/821/1*-7N0TWSie_-eEN8m6U6QtQ.png)

*Note!*
*Notice that the two T’s at the beginning was not recognized as part of the license plate number by OpenALPR. This might be related to this being a toy car without a valid license plate number syntax. Other tests i have done with actual license plate numbers seems to be working fine.*

# Required Software and libraries

Before we start writing our Python code for this project we need to make sure we have all the required software and libraries installed on our Raspberry PI. For this tutorial, besides [PyOTA](https://github.com/iotaledger/iota.py) itself, the following libraries are required:
\* The PiCamera library (already installed with Raspbian)
\* Requests (pip install requests)

------

# The Python Code

And here is the python code for this project..

```python
# Imports some required PyOTA libraries
import iota
from iota import Address

# Imports some libraries required by OpenALPR communication
import requests
import base64
import json

# Imports the CSV library used for DB comm. 
import csv

# Import PiCamera library
from picamera import PiCamera

# Setup the camera
camera = PiCamera()

# Rotate the image so that the lisence plate is placed horizontaly within the picture
# Depends on how you monted the camera
camera.rotation = 270

# Import the GPIO library
import RPi.GPIO as GPIO
import time
GPIO.setmode(GPIO.BCM)

# URL to IOTA fullnode used when interacting with the Tangle
iotaNode = "https://nodes.thetangle.org:443"

# Hotel owner recieving address, replace with your own recieving address
hotel_address = b'NYZBHOVSMDWWABXSACAJTTWJOQRPVVAWLBSFQVSJSWWBJJLLSQKNZFC9XCRPQSVFQZPBJCJRANNPVMMEZQJRQSVVGZ'

# Price of the parking service (10 IOTA)
price = 10

# Specify GPIO pins used by ultrasonic sensor
TRIG = 23 
ECHO = 24

# Variable used for monitoring when car enters/exits the sensor area
car_found = False

print "Distance Measurement In Progress"

# Setup the GPIO pins
GPIO.setup(TRIG,GPIO.OUT)
GPIO.setup(ECHO,GPIO.IN)

# Function for capturing image using the Raspberry PI camera
def capture_image():
    image_file = "/home/pi/Desktop/image.jpg"
    print("Capturing image...")
    camera.start_preview()
    time.sleep(1)
    camera.capture(image_file)
    camera.stop_preview()
    get_plate_id(image_file)

# Function for getting the plate ID from image using the OpenALPR Cloud API service 
def get_plate_id(image_file):

    # Replace with your OpenALPR secret key
    SECRET_KEY = 'PutYourOpenALPRSecretKeyHere'

    with open(image_file, 'rb') as image_file:
        img_base64 = base64.b64encode(image_file.read())

    # Send image to the OpenALPR Cloud service for decoding
    url = 'https://api.openalpr.com/v2/recognize_bytes?recognize_vehicle=1&country=us&secret_key=%s' % (SECRET_KEY)
    r = requests.post(url, data = img_base64)

    # Convert returned json to string 
    r_str = json.loads(json.dumps(r.json(), indent=2))
     
    # Search the Plate/SEED DB for a matching lisence plate
    # If found, get the related SEED
    try:
        if 'plate' in r_str['results'][0]:
            plate_id = r_str['results'][0]['plate']
            print(plate_id)
            get_seed(plate_id)
    except:
        print('OpenALPR did not return a plate ID')       



# Function for getting the seed used for IOTA payment
def get_seed(plate_id):

    plate_found = False

    with open('plates.csv') as csv_file:
        csv_reader = csv.reader(csv_file, delimiter=',')
        for row in csv_reader:
            if row[0] == plate_id:
                seed=row[1]
                plate_found = True
    
    if plate_found == True:
        print("Plate was found in DB, seed: " + seed)
        send_transaction(hotel_address, price, plate_id, seed)
    else:
        print("Plate was not found in DB")
        
# Function for sending the IOTA value transaction
def send_transaction(hotel_address, price, plate_id, seed):
    
    # Define api object
    api = iota.Iota(iotaNode, seed=seed)

    # Create transaction object
    tx1 = iota.ProposedTransaction( address = iota.Address(hotel_address), message = None, tag = iota.Tag(iota.TryteString.from_unicode(plate_id)), value = price)

    # Send transaction to tangle
    print("\nSending transaction... Please wait...")
    SentBundle = api.send_transfer(depth=3,transfers=[tx1], inputs=None, change_address=None, min_weight_magnitude=14)       

    # Display transaction sent confirmation message
    print("\nTransaction sent...")
        

# Check (every 2 sec.) for new cars entering or exiting the parking lot..
try:
    while True:

        GPIO.output(TRIG, False)
        print "Waiting For Sensor To Settle"
        time.sleep(2)

        GPIO.output(TRIG, True)
        time.sleep(0.00001)
        GPIO.output(TRIG, False)

        while GPIO.input(ECHO)==0:
          pulse_start = time.time()

        while GPIO.input(ECHO)==1:
          pulse_end = time.time()

        pulse_duration = pulse_end - pulse_start

        # Convert distance to cm
        distance = pulse_duration * 17150

        distance = round(distance, 2)
        
        # If distance between sensor and car is less than 10 cm
        if distance < 10:
            if car_found == False:
                capture_image()
                car_found = True
        else:
            car_found = False
                

except KeyboardInterrupt: # If there is a KeyboardInterrupt (when you press ctrl+c), exit the program and cleanup
    print("Cleaning up!")
    GPIO.cleanup()
```



<iframe src="https://medium.com/media/4b31d3f1b708c612c5b0d12b93d03e9b" allowfullscreen="" frameborder="0" height="3554" width="680" title="Python script for the Car-IOTA tutorial part 1" class="s t u jp ai" scrolling="auto" style="box-sizing: inherit; position: absolute; top: 0px; left: 0px; width: 680px; height: 3553.98px;"></iframe>

The source code for this python script can be downloaded from [here](https://gist.github.com/huggre/a481619cc47ecadd7c6e14299ff19eb9)

------

# About the Plate/SEED DB

The python script is looking for the “Plate/SEED DB” in a text file called **plates.csv** located in the home directory on your PI. Make sure you update this file with your plate numbers and SEED’s before running the project. You will find an example of how the **plates.csv** file should be structured [here](https://gist.github.com/huggre/5c648a628afbc2ed616305a478b902bb).

------

# Running the project

To run the the project, you first need to save the scrip from the previous section as text files on your computer.

Notice that Python program files uses the .py extension, so save the files as **car-iota-p1.py** on your Raspberry PI

To execute the scripts, simply start a new terminal window, navigate to the folder where you saved the script and type:

**python car-iota-p1.py**

You should now see the python script start checking for incoming cars every 2 sec. using the ultrasonic sensor. When a new car is found, we initiate the sequence as described in the “How is works” chapter. Check the raspberry terminal for statuses as the sequence progresses.

*Note!*
*In a real life scenario you would probably want to have some type of indicator telling the car owner if and when the transaction/payment was accepted (or not). This could be done using a light indicator switching from red to green, or even a physical barrier being removed.*

*Note!*
*In my example the Raspberry PI does all the work with respect to creating and signing the required IOTA value transactions as new cars enters the parking lot. You will soon notice that this is a pretty slow process due to the limited resources of the PI. In a real life scenario this would probably not be acceptable and we must look for other alternatives. One option would be to outsource these activities to a centralized entity that has the resources of performing these activities efficiently.*

------

# Whats next?

While the solution proposed in this tutorial might work for some local use-cases. For other use-cases, the concept of a centralized entity (in this case the hotel owner) controlling the SEEDS would not be practical or acceptable. For a truly global and decentralized solution we probably need to take a different approach. More about that next time.

------

# Donations

If you like this tutorial and want me to continue making others, feel free to make a small donation to the IOTA address shown below.

![img](https://miro.medium.com/max/382/1*j2ENIzmDzXcGSgAdY4w-Jw.png)

NYZBHOVSMDWWABXSACAJTTWJOQRPVVAWLBSFQVSJSWWBJJLLSQKNZFC9XCRPQSVFQZPBJCJRANNPVMMEZQJRQSVVGZ

